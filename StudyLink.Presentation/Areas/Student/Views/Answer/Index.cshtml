@model List<StudyLink.Application.ViewModels.AddAnswerVM>

@{
    ViewData["Title"] = "Quiz";
}

<h2>Quiz</h2>

<div id="timer" class="mt-4" style="font-size: 20px; font-weight: bold;">Time Remaining: <span id="timer-display">00:00</span></div>

<form id="quiz-form" action="@Url.Action("AddAnswer", "Answer")" method="post">
    <div id="question-container" class="mt-4"></div>
    <div id="navigation-buttons" class="mt-4">
        <div id="prev-btn"></div>
        <div id="next-btn"></div>
        <div id="submit-btn"></div>
    </div>
</form>

<div id="popup-container">
    <div class="popup-content">
        <h4 id="popup-message-title"></h4>
        <p id="popup-message-text"></p>
    </div>
</div>

@section Scripts {
    <script>
        let questions = @Html.Raw(Json.Serialize(Model));
        let userAnswers = {};
        let currentQuestionIndex = 0;
        let countdownTimer;
        let timeLeftInSeconds = 60 * 0.1; // 10 minutes
        let popupInstance;

        function updateTimer() {
            let minutes = Math.floor(timeLeftInSeconds / 60);
            let seconds = timeLeftInSeconds % 60;
            $("#timer-display").text(`${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);

            if (timeLeftInSeconds <= 0) {
                clearInterval(countdownTimer);
                showPopup("Time's up!", "Your time has expired. The quiz will be submitted automatically.");
            } else {
                timeLeftInSeconds--;
            }
        }

        function startTimer() {
            countdownTimer = setInterval(updateTimer, 1000);
        }

        function showPopup(title, message) {
            $("#popup-message-title").text(title);
            $("#popup-message-text").text(message);

            popupInstance.option("contentTemplate", function () {
                let contentDiv = $("<div>").append(
                    $("<h4>").text(title).addClass("popup-title"),
                    $("<p>").text(message).addClass("popup-message-text")
                );
                return contentDiv;
            });

            popupInstance.option("visible", true);
        }

        function renderQuestion() {
            let question = questions[currentQuestionIndex];
            let questionHtml = `
                <div class="card mb-4">
                    <div class="card-header">
                        <strong>Q${currentQuestionIndex + 1}: </strong>${question.questionText}
                    </div>
                    <div class="card-body">
                        <div id="radio-group-${question.questionId}" class="row"></div>
                    </div>
                </div>
            `;
            $("#question-container").html(questionHtml);

            $(`#radio-group-${question.questionId}`).dxRadioGroup({
                items: question.choices.map((choice, index) => ({
                    value: choice.choiceId,
                    text: `${String.fromCharCode(65 + index)}. ${choice.choiceText}`
                })),
                displayExpr: "text",
                valueExpr: "value",
                value: userAnswers[question.questionId] || null,
                onValueChanged: (e) => userAnswers[question.questionId] = e.value
            });

            $("#prev-btn").dxButton({
                text: "Previous",
                visible: currentQuestionIndex > 0,
                onClick: () => { if (currentQuestionIndex > 0) currentQuestionIndex--; renderQuestion(); }
            });

            $("#next-btn").dxButton({
                text: "Next",
                visible: currentQuestionIndex < questions.length - 1,
                onClick: () => { if (currentQuestionIndex < questions.length - 1) currentQuestionIndex++; renderQuestion(); }
            });

            $("#submit-btn").dxButton({
                text: "Submit",
                stylingMode: "contained",
                type: "success",
                visible: currentQuestionIndex === questions.length - 1,
                onClick: () => {
                    let unansweredQuestions = questions.filter(q => !userAnswers[q.questionId]);
                    if (unansweredQuestions.length > 0) {
                        showPopup("Incomplete Answers", "Please answer all the questions before submitting.");
                        return;
                    }

                    let form = $("#quiz-form");
                    form.find("input[type=hidden]").remove();
                    questions.forEach((question, index) => {
                        form.append(`<input type="hidden" name="[${index}].QuestionId" value="${question.questionId}" />`);
                        form.append(`<input type="hidden" name="[${index}].Answer.ChoiceId" value="${userAnswers[question.questionId]}" />`);
                    });
                    form.submit();
                }
            });
        }

        $(function () {
            renderQuestion();
            startTimer();

            popupInstance = $("#popup-container").dxPopup({
                visible: false,
                dragEnabled: true,
                closeOnOutsideClick: false,
                showTitle: true,
                title: "Message",
                width: 300,
                height: 200
            }).dxPopup("instance");
        });
    </script>
}
